'use strict';
const INTERFACES = require('../enums').INTERFACES;
const TRANSPORT = require('../enums').TRANSPORT;
const Transports = require('../transports');

const ARGS_CLEANUP = new WeakMap();
// TODO: do context spread too right?
module.exports = function (payload, ecoSystemInterface) {

    const request = payload.request;
    if (request !== 'sqlite3') {
        return;
    }

    const instrumentation = ecoSystemInterface.getInterface(INTERFACES.INSTRUMENTATION);
    const transport = ecoSystemInterface.getInterface(INTERFACES.TRANSPORT);
    const module = payload.module;
    const identity = payload.identity;

    const pre = {
        method: function (args, value, rule, selfObject) {

            const todo = transport.shouldPropagate(TRANSPORT.SCOPE.CLIENT);
            const trigger = todo.trigger;
            const fields = todo.fields;
            if (fields.length === 0) {
                return; // Do nothing here
            }
            const resolved = new Transports.ClientTransport();
            resolved.addTransport(fields, TRANSPORT.TRANSPORT_TYPE.SQLITE);
            resolved.addTA(fields, ecoSystemInterface);
            if (fields.indexOf('host') > -1) {
                resolved.host = selfObject.filename;
            }
            const cleanup = transport.propagate(resolved, trigger);
            ARGS_CLEANUP.set(args, cleanup);
        }
    };

    const asyncPost = {
        method: function (args) {

            const cleanup = ARGS_CLEANUP.get(args);
            if (typeof cleanup === 'function') {
                cleanup();
            }
        }
    };
    const methods = ['run', 'get', 'all', 'each',
        // 'exec', TODO: re-patch it one day, right now it's RO for real
        'prepare'];
    methods.forEach((k) => {

        // TODO: check name for dynamic instrumentation
        instrumentation.strategies.wrap(module.Database.prototype, k, identity, 'Database.prototype', pre, null, asyncPost);
    });
};
